#!/bin/bash

set -xe

DL_PREFIX=${LF_REPO_PREFIX:-$DL_PREFIX}
LIFERAY_HOME=${APP_ROOT}$LIFERAY_HOME

mkdir /tmp/cache_jars

for d in {${LF_CACHE_JAR_1},${LF_CACHE_JAR_2},${LF_CACHE_JAR_3}}.jar ; do
    curl -k -Lo /tmp/cache_jars/$d ${CACHE_JARS_URL}${d}
done

for d in {${LF_DEPS},${LF_OSGI_DEPS}}-${LF_VERSION}-${LF_BUILD}.zip ; do
    curl -k -Lo /tmp/$d ${DL_PREFIX}/${d}${DL_SUFFIX}
done

mkdir -p $WILDFLY_HOME/modules/com/liferay/portal/main
ls -la /
mkdir -p $LIFERAY_HOME/osgi
mkdir -p $LIFERAY_HOME/portal
cp -a /tmp/cache_jars/* $LIFERAY_HOME/portal/

unzip -j -d $WILDFLY_HOME/modules/com/liferay/portal/main /tmp/${LF_DEPS}-${LF_VERSION}-${LF_BUILD}.zip

unzip -d $LIFERAY_HOME/osgi /tmp/${LF_OSGI_DEPS}-${LF_VERSION}-${LF_BUILD}.zip
mv $LIFERAY_HOME/osgi/${LF_OSGI_DEPS}-${LF_VERSION}/* $LIFERAY_HOME/osgi
rm -rf $LIFERAY_HOME/osgi/${LF_OSGI_DEPS}-${LF_VERSION}

rm -rf /tmp/liferay-ce-*.zip

cat > $WILDFLY_HOME/modules/com/liferay/portal/main/module.xml << EOF
<?xml version="1.0"?>

<module xmlns="urn:jboss:module:1.0" name="com.liferay.portal">
    <resources>
        <resource-root path="com.liferay.registry.api.jar" />
        <resource-root path="portal-kernel.jar" />
        <resource-root path="portlet.jar" />
        <resource-root path="hsql.jar" />
    </resources>
    <dependencies>
        <module name="javax.api" />
        <module name="javax.mail.api" />
        <module name="javax.servlet.api" />
        <module name="javax.servlet.jsp.api" />
        <module name="javax.transaction.api" />
    </dependencies>
</module>
EOF

#cat > $LIFERAY_HOME/portal-ext.properties << EOF
#jdbc.default.jndi.name=java:jboss/datasources/LiferayDS
#EOF

$WILDFLY_HOME/bin/jboss-cli.sh --commands="\
embed-server --admin-only --std-out=echo,\
/subsystem=undertow/server=default-server/http-listener=default:read-attribute(name=url-charset),\
/subsystem=deployment-scanner/scanner=default:read-attribute(name=deployment-timeout),\
/subsystem=security/security-domain=PortalRealm:add(cache-type=default),\
/subsystem=security/security-domain=PortalRealm/authentication=classic:add(),\
/subsystem=security/security-domain=PortalRealm/authentication=classic/login-module=liferay:add(\
 code=com.liferay.portal.security.jaas.PortalLoginModule, flag=required),\
/subsystem=undertow/server=default-server/host=default-host/location=\/:remove(),\
/system-property=jboss.as.management.blocking.timeout:add(value=900),\
/subsystem=deployment-scanner/scanner=default:write-attribute(name=deployment-timeout,value=900)
"

#export SERVER_HOME=$LIFERAY_HOME/wildfly
export SERVER_HOME=$WILDFLY_HOME

#mkdir -p $SERVER_HOME
#tar -C $WILDFLY_HOME -c standalone | tar -C $SERVER_HOME -x
ln -s $WILDFLY_HOME $LIFERAY_HOME

curl -k -Lo /tmp/${LF_PORTAL}-${LF_VERSION}-${LF_BUILD}.war ${DL_PREFIX}/${LF_PORTAL}-${LF_VERSION}-${LF_BUILD}.war${DL_SUFFIX}
mkdir -p $WILDFLY_HOME/standalone/deployments/ROOT.war
unzip -d $WILDFLY_HOME/standalone/deployments/ROOT.war /tmp/${LF_PORTAL}-${LF_VERSION}-${LF_BUILD}.war
cat > $WILDFLY_HOME/standalone/deployments/ROOT.war.dodeploy << EOF
EOF

cat > $LIFERAY_HOME/osgi/configs/com.liferay.portal.search.elasticsearch.configuration.ElasticsearchConfiguration.config << EOF
operationMode="REMOTE" 
transportAddresses="${ELASTIC_SERVICE_HOST}:${ELASTIC_SERVICE_PORT}" 
EOF

cat > $LIFERAY_HOME/osgi/configs/com.liferay.portal.store.file.system.configuration.AdvancedFileSystemStoreConfiguration.cfg << EOF
rootDir=data/document_library 
EOF

rm -rf /tmp/${LF_PORTAL}-${LF_VERSION}-${LF_BUILD}.war

rm -rf $SERVER_HOME/standalone/configuration/standalone_xml_history

function fix_perms() {
    local path=$1
    local mode=${2:-"g+w"}

    chgrp -R 0 $path
    chmod -R $mode $path
}

for d in $SERVER_HOME/standalone/{configuration,data,deployments,log,tmp} $LIFERAY_HOME/osgi ; do
    fix_perms $d
done

#Add write permission to group - Lifereay could not write portal-setup-wizard.properties without it
chmod g+rw $LIFERAY_HOME
